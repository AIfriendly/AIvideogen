# Test Design: Story 4.1 - Scene-by-Scene UI Layout & Script Display

**Generated By**: BMad TEA Agent (Master Test Architect - Murat)
**Date**: 2025-11-19
**Epic**: 4 - Visual Curation Interface
**Story**: 4.1 - Scene-by-Scene UI Layout & Script Display
**Design Level**: Full (comprehensive risk assessment and coverage planning)

---

## Executive Summary

This test design provides comprehensive risk assessment, test scenario planning, and execution strategy for Story 4.1. The story establishes the foundational UI structure for the Visual Curation Interface, enabling users to review AI-generated scripts scene-by-scene before finalizing video assembly.

**Key Findings:**
- **Total Risks Identified**: 12 risks across 6 categories
- **High-Priority Risks (≥6)**: 4 critical risks requiring immediate mitigation
- **Test Scenarios**: 24 total (8 P0, 9 P1, 5 P2, 2 P3)
- **Estimated Effort**: 38 hours (~5 days)
- **Coverage Target**: ≥90% for critical paths

---

## Story Context

**Story 4.1 Goal**: Create the foundational UI structure for the visual curation page with scene-by-scene layout

**User Story**:
> As a user who has completed script generation, voiceover synthesis, and visual sourcing,
> I want to see my script displayed scene-by-scene in a clear, organized layout,
> so that I can review each scene's content before curating the visual clips for final video assembly.

**Acceptance Criteria** (from Tech Spec Epic 4 lines 531-538):
1. VisualCuration page displays after visual sourcing completes (current_step = 'visual-curation')
2. All scenes displayed in sequential order (Scene 1, Scene 2, Scene 3...)
3. Each scene section shows scene number and complete script text
4. Scene data loads from database via GET /api/projects/[id]/scenes endpoint
5. Loading indicator displays while fetching scene data
6. Error messages display if scenes cannot be loaded
7. Layout is responsive and readable on desktop (1920px) and tablet (768px) screens
8. Empty state displays if no scenes exist for project

**Implementation Scope**:
- VisualCuration.tsx page component (`app/projects/[id]/visual-curation/page.tsx`)
- SceneCard.tsx component (`components/features/curation/SceneCard.tsx`)
- GET /api/projects/[id]/scenes API endpoint (`app/api/projects/[id]/scenes/route.ts`)
- Skeleton.tsx loading component (`components/ui/skeleton.tsx`)
- Responsive layout with Tailwind CSS v4

---

## Risk Assessment Matrix

### Risk Scoring Methodology

**Probability Scale** (1-3):
- 1 (Unlikely): <10% chance, edge case
- 2 (Possible): 10-50% chance, known scenario
- 3 (Likely): >50% chance, common occurrence

**Impact Scale** (1-3):
- 1 (Minor): Cosmetic, workaround exists, limited users
- 2 (Degraded): Feature impaired, workaround difficult, affects many users
- 3 (Critical): System failure, data loss, no workaround, blocks usage

**Risk Score** = Probability × Impact (1-9)
- **Scores 1-2**: Low risk (monitor)
- **Scores 3-4**: Medium risk (plan mitigation)
- **Scores 6-9**: High risk (immediate mitigation required)

### Identified Risks

| Risk ID | Category | Description | Probability | Impact | Score | Priority | Mitigation Strategy |
|---------|----------|-------------|-------------|--------|-------|----------|---------------------|
| **R-001** | **DATA** | **GET /scenes endpoint returns incorrect data (wrong project scenes)** | **3** | **3** | **9** | **P0** | **Validate project_id foreign key constraint, add API tests with multiple projects** |
| **R-002** | **BUS** | **Scene order incorrect (scenes displayed out of sequence)** | **2** | **3** | **6** | **P0** | **Verify ORDER BY scene_number ASC in query, add E2E tests for ordering** |
| **R-003** | **TECH** | **Race condition: UI renders before scenes data loads** | **3** | **2** | **6** | **P0** | **Implement proper loading state management, network-first pattern** |
| **R-004** | **BUS** | **Empty state not shown when project has no scenes** | **2** | **3** | **6** | **P0** | **Add conditional rendering logic, E2E test for empty projects** |
| R-005 | TECH | Large scene text causes UI layout break | 2 | 2 | 4 | P1 | Test with 500+ word scenes, add text truncation/scroll |
| R-006 | PERF | Slow API response causes UI hang (>5 seconds) | 1 | 3 | 3 | P1 | Add timeout handling, loading state optimization |
| R-007 | BUS | Error state not shown when API call fails | 2 | 2 | 4 | P1 | Implement error boundary, test network failures |
| R-008 | TECH | Responsive layout breaks on tablet (768px) | 2 | 2 | 4 | P1 | Add responsive tests at multiple breakpoints |
| R-009 | SEC | Unauthorized access to other users' scenes | 1 | 3 | 3 | P1 | Validate project ownership (deferred - single-user app) |
| R-010 | DATA | Database connection failure shows cryptic error | 1 | 2 | 2 | P2 | Add user-friendly error messages |
| R-011 | BUS | Loading skeleton count mismatch (shows 3, project has 8 scenes) | 1 | 1 | 1 | P3 | Accept mismatch (cosmetic only) |
| R-012 | TECH | Memory leak with many scenes (>50) | 1 | 2 | 2 | P3 | Monitor, defer optimization to post-MVP |

**High-Priority Risks Summary** (Score ≥6):
- **R-001** (Score 9): Data integrity - wrong scenes returned (CRITICAL)
- **R-002** (Score 6): Scene ordering breaks user experience
- **R-003** (Score 6): Race condition causes empty UI flash
- **R-004** (Score 6): Empty state not shown (user confusion)

**Total Risks**: 12 (4 High, 4 Medium, 4 Low)

---

## Test Coverage Design

### Coverage Matrix

| AC# | Requirement | Risk Links | Test Level | Priority | Test Count | Owner | Effort (hrs) |
|-----|-------------|------------|------------|----------|------------|-------|--------------|
| AC1 | Page displays after visual sourcing (current_step validation) | R-004 | E2E | P0 | 2 | Dev | 1.5 |
| AC2 | Scenes displayed in sequential order | R-001, R-002 | E2E, API | P0 | 3 | Dev | 2.0 |
| AC3 | Scene number and text displayed correctly | R-005 | Component, E2E | P1 | 3 | Dev | 2.0 |
| AC4 | Data loads via GET /api/projects/[id]/scenes | R-001, R-006 | API | P0 | 4 | Dev | 3.0 |
| AC5 | Loading indicator displays while fetching | R-003 | E2E | P1 | 2 | Dev | 1.5 |
| AC6 | Error messages display if load fails | R-007, R-010 | E2E, API | P1 | 3 | Dev | 2.5 |
| AC7 | Responsive layout (1920px desktop, 768px tablet) | R-008 | E2E | P1 | 4 | Dev | 3.0 |
| AC8 | Empty state displays if no scenes | R-004 | E2E, API | P0 | 3 | Dev | 2.0 |

**Total**: 24 tests across 8 acceptance criteria, 38 hours effort

### Test Level Distribution

**Test Level Selection Strategy** (from `test-levels-framework.md`):

| Test Level | Count | Percentage | Rationale |
|------------|-------|------------|-----------|
| **E2E** | 10 | 42% | Critical user workflow, page rendering validation |
| **API** | 8 | 33% | Data retrieval correctness, error handling |
| **Component** | 5 | 21% | SceneCard rendering, loading states |
| **Unit** | 1 | 4% | Helper functions (if any) |

**E2E Tests** (Playwright):
- Critical user journeys (AC1, AC2, AC7, AC8)
- Multi-component integration (page → API → UI rendering)
- Visual validation (responsive layout, loading states)

**API Tests** (Vitest):
- GET /api/projects/[id]/scenes endpoint (AC4, AC6, AC8)
- Data correctness (ordering, filtering, error responses)
- Fast feedback for backend logic

**Component Tests** (Vitest + React Testing Library):
- SceneCard.tsx rendering (AC3)
- Skeleton.tsx loading states (AC5)
- Isolated from API dependencies

**Unit Tests** (Vitest):
- Utility functions (if extracted)

---

## Test Scenarios by Priority

### P0 Tests (Critical - Run on Every Commit)

**Risk Mitigation:** R-001 (Score 9), R-002 (Score 6), R-003 (Score 6), R-004 (Score 6)

| Test ID | Test Scenario | Test Level | AC# | Risk | Effort |
|---------|---------------|------------|-----|------|--------|
| **4.1-API-001** | **GET /scenes returns correct scenes for project (not other projects)** | **API** | **AC4** | **R-001** | **1h** |
| **4.1-API-002** | **GET /scenes returns scenes ordered by scene_number ASC** | **API** | **AC2, AC4** | **R-001, R-002** | **0.5h** |
| **4.1-API-003** | **GET /scenes returns 404 for non-existent project** | **API** | **AC6** | **R-007** | **0.5h** |
| **4.1-API-004** | **GET /scenes returns empty array for project with no scenes** | **API** | **AC8** | **R-004** | **1h** |
| **4.1-E2E-001** | **VisualCuration page displays all scenes in sequential order (Scene 1, 2, 3...)** | **E2E** | **AC1, AC2** | **R-002** | **1.5h** |
| **4.1-E2E-002** | **Each scene section shows scene number and complete script text** | **E2E** | **AC3** | **-** | **1h** |
| **4.1-E2E-003** | **Empty state displays when project has no scenes** | **E2E** | **AC8** | **R-004** | **1h** |
| **4.1-E2E-004** | **Page only accessible when current_step = 'visual-curation'** | **E2E** | **AC1** | **-** | **0.5h** |

**P0 Subtotal**: 8 tests, 7 hours

### P1 Tests (High - Run on PR to Main)

**Risk Mitigation:** R-005 (Score 4), R-006 (Score 3), R-007 (Score 4), R-008 (Score 4)

| Test ID | Test Scenario | Test Level | AC# | Risk | Effort |
|---------|---------------|------------|-----|------|--------|
| 4.1-API-005 | GET /scenes handles database errors gracefully (returns 500) | API | AC6 | R-010 | 1h |
| 4.1-API-006 | GET /scenes validates project_id format (rejects invalid UUIDs) | API | AC4 | R-001 | 0.5h |
| 4.1-E2E-005 | Loading skeleton displays while fetching scene data | E2E | AC5 | R-003 | 1h |
| 4.1-E2E-006 | Error message displays when API call fails (network error) | E2E | AC6 | R-007 | 1.5h |
| 4.1-E2E-007 | Error message displays when API returns 500 error | E2E | AC6 | R-007, R-010 | 1h |
| 4.1-E2E-008 | Layout is responsive on desktop (1920px) - all scenes visible | E2E | AC7 | R-008 | 1.5h |
| 4.1-E2E-009 | Layout is responsive on tablet (768px) - text readable, no overflow | E2E | AC7 | R-008 | 1.5h |
| 4.1-UNIT-001 | SceneCard component renders scene number and text correctly | Component | AC3 | - | 1h |
| 4.1-UNIT-002 | SceneCard component handles long text (500+ words) without layout break | Component | AC3 | R-005 | 1h |

**P1 Subtotal**: 9 tests, 10 hours

### P2 Tests (Medium - Run Nightly)

**Risk Mitigation:** R-005 (Score 4), R-010 (Score 2)

| Test ID | Test Scenario | Test Level | AC# | Risk | Effort |
|---------|---------------|------------|-----|------|--------|
| 4.1-E2E-010 | Retry button re-fetches scenes after error | E2E | AC6 | R-007 | 2h |
| 4.1-E2E-011 | "Back to Script Generation" button works in empty state | E2E | AC8 | - | 1h |
| 4.1-UNIT-003 | Skeleton component displays 3 placeholders | Component | AC5 | R-011 | 0.5h |
| 4.1-UNIT-004 | Scene duration indicator displays correctly (e.g., "5.2s") | Component | AC3 | - | 1h |
| 4.1-API-007 | GET /scenes includes all scene fields (id, project_id, scene_number, text, audio_file_path, duration) | API | AC4 | - | 1h |

**P2 Subtotal**: 5 tests, 5.5 hours

### P3 Tests (Low - Run On-Demand)

**Risk Mitigation:** R-011 (Score 1), R-012 (Score 2)

| Test ID | Test Scenario | Test Level | AC# | Risk | Effort |
|---------|---------------|------------|-----|------|--------|
| 4.1-PERF-001 | Page renders with 10 scenes in <2 seconds | E2E | AC7 | R-012 | 2h |
| 4.1-UNIT-005 | VisualCurationClient component manages loading/error state correctly | Component | AC5, AC6 | R-003 | 1h |

**P3 Subtotal**: 2 tests, 3 hours

---

## Test Execution Strategy

### Execution Order

**1. Smoke Tests** (<3 minutes):
- 4.1-API-001: GET /scenes returns correct data
- 4.1-E2E-001: Page displays scenes in order

**2. P0 Tests** (<10 minutes):
- All 8 P0 tests (critical paths, data integrity, empty states)

**3. P1 Tests** (<20 minutes):
- All 9 P1 tests (error handling, responsive layout, component rendering)

**4. P2 Tests** (<10 minutes):
- All 5 P2 tests (retry functionality, edge cases)

**5. P3 Tests** (on-demand):
- 2 P3 tests (performance benchmarks, advanced scenarios)

**Total Suite Runtime**: ~45 minutes (P0-P2), ~48 minutes (full suite)

### Test Data Requirements

**Data Factories Needed** (from `data-factories.md`):

```typescript
// factories/project.factory.ts
export const createProject = (overrides?: Partial<Project>): Project => ({
  id: faker.string.uuid(),
  name: faker.commerce.productName(),
  current_step: 'visual-curation',
  ...overrides,
});

// factories/scene.factory.ts
export const createScene = (overrides?: Partial<Scene>): Scene => ({
  id: faker.string.uuid(),
  project_id: 'project-id-placeholder',
  scene_number: 1,
  text: faker.lorem.paragraphs(2),
  sanitized_text: faker.lorem.paragraphs(2),
  audio_file_path: `.cache/audio/scene-${faker.number.int({ min: 1, max: 10 })}.mp3`,
  duration: faker.number.float({ min: 3, max: 15, precision: 0.1 }),
  ...overrides,
});

// factories/scene-set.factory.ts
export const createSceneSet = (projectId: string, count: number = 4): Scene[] => {
  return Array.from({ length: count }, (_, i) =>
    createScene({
      project_id: projectId,
      scene_number: i + 1,
      text: `Scene ${i + 1} text content`,
    })
  );
};
```

**Test Environment Setup**:
- SQLite test database (in-memory or temp file)
- Seed projects with `createProject()` factory
- Seed scenes with `createSceneSet()` factory
- Clean up after each test (afterEach hooks)

### Fixtures & Page Objects

**Fixtures** (from `fixture-architecture.md`):

```typescript
// fixtures/database.fixture.ts
export const test = base.extend({
  testProject: async ({}, use) => {
    const project = createProject({ current_step: 'visual-curation' });
    await seedProject(project);
    const scenes = createSceneSet(project.id, 4);
    await seedScenes(scenes);

    await use({ project, scenes });

    // Auto-cleanup
    await deleteProject(project.id);
  },
});
```

**Page Objects** (optional, for E2E tests):

```typescript
// page-objects/visual-curation.page.ts
export class VisualCurationPage {
  constructor(private page: Page) {}

  async goto(projectId: string) {
    await this.page.goto(`/projects/${projectId}/visual-curation`);
  }

  async getSceneCards() {
    return await this.page.getByTestId('scene-card').all();
  }

  async getSceneNumber(index: number) {
    const card = await this.page.getByTestId('scene-card').nth(index);
    return await card.getByTestId('scene-number').textContent();
  }

  async isLoadingDisplayed() {
    return await this.page.getByTestId('loading-skeleton').isVisible();
  }

  async getErrorMessage() {
    return await this.page.getByTestId('error-message').textContent();
  }

  async clickRetryButton() {
    await this.page.getByTestId('retry-button').click();
  }
}
```

---

## Quality Gate Criteria

### Pass/Fail Thresholds

**Gate 1: Code Review** (before merge):
- ✅ All P0 tests exist and pass (8/8 tests)
- ✅ All P1 tests exist and pass (9/9 tests)
- ✅ No high-priority risks (score ≥6) unmitigated
- ✅ Code review approved by senior dev

**Gate 2: PR to Main** (before deployment):
- ✅ P0 pass rate: 100% (0 failures allowed)
- ✅ P1 pass rate: ≥95% (max 1 failure allowed)
- ✅ P2 pass rate: ≥90%
- ✅ Test coverage ≥85% for API endpoint and page components

**Gate 3: Story Completion** (before marking "done"):
- ✅ All 8 acceptance criteria covered by passing tests
- ✅ Test design reviewed and approved by TEA agent
- ✅ No P0/P1 tests skipped or marked `.skip()`
- ✅ Test suite runtime <50 minutes (P0-P2 suite)

### Coverage Targets

| Component | Target Coverage | Minimum Coverage |
|-----------|----------------|------------------|
| GET /api/projects/[id]/scenes | 95% | 90% |
| VisualCurationClient.tsx | 90% | 85% |
| SceneCard.tsx | 90% | 85% |
| Skeleton.tsx | 85% | 80% |

---

## Traceability Matrix

### Requirements → Risks → Tests Mapping

| AC# | Requirement | Risks | P0 Tests | P1 Tests | P2 Tests | P3 Tests | Coverage |
|-----|-------------|-------|----------|----------|----------|----------|----------|
| AC1 | Page displays after visual sourcing | R-004 | 4.1-E2E-004 | - | - | - | 100% |
| AC2 | Scenes in sequential order | R-001, R-002 | 4.1-API-002, 4.1-E2E-001 | - | - | - | 100% |
| AC3 | Scene number and text displayed | R-005 | 4.1-E2E-002 | 4.1-UNIT-001, 4.1-UNIT-002 | 4.1-UNIT-004 | - | 100% |
| AC4 | Data loads via API | R-001, R-006 | 4.1-API-001, 4.1-API-002, 4.1-API-003 | 4.1-API-005, 4.1-API-006 | 4.1-API-007 | - | 100% |
| AC5 | Loading indicator displays | R-003 | - | 4.1-E2E-005 | 4.1-UNIT-003 | 4.1-UNIT-005 | 100% |
| AC6 | Error messages display | R-007, R-010 | 4.1-API-003 | 4.1-E2E-006, 4.1-E2E-007 | 4.1-E2E-010 | 4.1-UNIT-005 | 100% |
| AC7 | Responsive layout (1920px, 768px) | R-008 | - | 4.1-E2E-008, 4.1-E2E-009 | - | 4.1-PERF-001 | 100% |
| AC8 | Empty state displays | R-004 | 4.1-API-004, 4.1-E2E-003 | - | 4.1-E2E-011 | - | 100% |

**Total Coverage**: 8/8 acceptance criteria (100%)

---

## Resource Estimates

### Test Development Effort

| Priority | Test Count | Hours per Test | Total Hours | Total Days (8hr/day) |
|----------|------------|----------------|-------------|----------------------|
| P0 | 8 | 0.875 avg | 7.0 | 0.9 |
| P1 | 9 | 1.11 avg | 10.0 | 1.25 |
| P2 | 5 | 1.1 avg | 5.5 | 0.7 |
| P3 | 2 | 1.5 avg | 3.0 | 0.4 |
| **Total** | **24** | **1.06 avg** | **25.5** | **3.2** |

### Additional Effort

| Task | Effort | Description |
|------|--------|-------------|
| Data factories setup | 2 hours | Create project, scene, and scene-set factories |
| Fixtures setup | 2 hours | Database fixture with auto-cleanup |
| Page objects (optional) | 3 hours | VisualCurationPage class for E2E tests |
| Test infrastructure | 2 hours | Configure Playwright, Vitest, test database |
| Documentation | 1 hour | Test README, contributing guide |
| **Subtotal** | **10 hours** | **1.25 days** |

**Grand Total**: 35.5 hours (~4.5 days) for complete test implementation

### Test Maintenance Effort

**Ongoing maintenance** (per sprint):
- Update tests for requirement changes: 2-4 hours
- Fix flaky tests: 1-2 hours
- Add new edge case tests: 2-3 hours

**Estimated ongoing**: 5-9 hours per sprint

---

## Test Design Decision Log

### Decision 1: Test Level Split (42% E2E, 33% API, 21% Component, 4% Unit)

**Rationale**:
- Story 4.1 is foundational UI + API integration (heavy E2E need)
- API endpoint correctness is critical (R-001 score 9) → API tests
- SceneCard component is simple → minimal component tests
- No complex business logic → minimal unit tests

**Trade-off**: E2E tests are slower but necessary for visual validation (responsive layout, loading states, empty states)

**Knowledge Base Reference**: `test-levels-framework.md` (lines 150-220)

### Decision 2: P0 Priority Assignment (8 tests)

**Rationale**:
- All tests mitigating high-risk items (score ≥6) → P0
- Data integrity tests (R-001, R-002) → P0
- Empty state validation (R-004) → P0 (user confusion risk)

**Trade-off**: Higher P0 count (8 tests) increases CI time but ensures critical paths validated

**Knowledge Base Reference**: `test-priorities-matrix.md`, `risk-governance.md`

### Decision 3: Data Factories Pattern (not hardcoded fixtures)

**Rationale**:
- Parallel test execution safety (unique UUIDs)
- Schema evolution resilience (factory defaults adapt)
- Test intent clarity (overrides show what matters)

**Knowledge Base Reference**: `data-factories.md` (lines 1-100)

### Decision 4: Fixture Auto-Cleanup (afterEach hooks)

**Rationale**:
- Test isolation (no shared state pollution)
- Parallel execution support
- Prevents database bloat in test runs

**Knowledge Base Reference**: `fixture-architecture.md`, `test-quality.md`

---

## Assumptions and Constraints

### Assumptions

1. **Single-User App**: No multi-tenancy, no authentication required (simplifies security testing)
2. **SQLite Database**: Test database can use in-memory SQLite or temp file
3. **Typical Scene Count**: 3-5 scenes per project (edge case: 10-15 scenes acceptable)
4. **Network Latency**: Local API responses <500ms (no CDN/geographic distribution)
5. **Browser Support**: Modern browsers only (Chrome, Firefox, Safari latest 2 versions)

### Constraints

1. **Test Framework**: Vitest (unit/API), Playwright (E2E) - already established in codebase
2. **Test Execution Time**: P0-P2 suite must complete in <50 minutes
3. **CI/CD Pipeline**: Tests run on GitHub Actions (or similar CI)
4. **Development Environment**: Windows development environment (paths, file system)
5. **Story Dependencies**: Story 4.1 is foundational - Stories 4.2-4.6 depend on this being validated

### Known Gaps (Deferred to Future Stories)

1. **Authentication**: Security testing deferred (single-user app for MVP)
2. **Performance**: Load testing with 50+ scenes deferred to post-MVP (R-012)
3. **Accessibility**: ARIA/screen reader testing deferred to Epic 4 polish phase
4. **Visual Regression**: Screenshot comparison testing deferred (nice-to-have)
5. **Mobile Viewports**: <768px responsive testing deferred to post-MVP

---

## Next Steps

### Immediate Actions (Before Implementation)

1. **Review test design with team** (30 min meeting)
   - Validate risk assessment and priorities
   - Confirm test level distribution
   - Approve resource allocation

2. **Set up test infrastructure** (2 hours)
   - Configure Vitest for API/component tests
   - Configure Playwright for E2E tests
   - Create test database setup script

3. **Create data factories** (2 hours)
   - `factories/project.factory.ts`
   - `factories/scene.factory.ts`
   - `factories/scene-set.factory.ts`

4. **Create database fixture** (2 hours)
   - `fixtures/database.fixture.ts` with auto-cleanup
   - Seed/teardown helpers

### Implementation Phase (Following ATDD Workflow)

1. **Run `*atdd` workflow** to generate failing tests for P0 scenarios (4 hours)
   - Generate 8 P0 test stubs from acceptance criteria
   - Tests fail initially (TDD red phase)

2. **Implement Story 4.1 code** (12 hours - from story estimate)
   - API endpoint, page component, scene card component
   - Run tests frequently (TDD green phase)

3. **Write P1 tests** (10 hours)
   - Error handling, responsive layout, component tests

4. **Write P2/P3 tests** (8 hours)
   - Edge cases, retry functionality, performance benchmarks

5. **Refactor** (2 hours)
   - Code cleanup, test cleanup (TDD refactor phase)

### Validation Phase

1. **Run test-review workflow** to validate test quality
   - Target score: 85+ (Good)
   - Fix any quality violations

2. **Run full test suite** and verify quality gates
   - P0 pass rate: 100%
   - P1 pass rate: ≥95%
   - P2 pass rate: ≥90%

3. **Mark Story 4.1 as "done"** only after all tests pass

---

## Knowledge Base References

This test design consulted the following knowledge base fragments:

- **[risk-governance.md](../.bmad/bmm/testarch/knowledge/risk-governance.md)** - Risk scoring (probability × impact), category classification, automated gate decisions
- **[probability-impact.md](../.bmad/bmm/testarch/knowledge/probability-impact.md)** - Risk matrix methodology, threshold criteria
- **[test-levels-framework.md](../.bmad/bmm/testarch/knowledge/test-levels-framework.md)** - E2E vs API vs Component vs Unit decision matrix
- **[test-priorities-matrix.md](../.bmad/bmm/testarch/knowledge/test-priorities-matrix.md)** - P0-P3 classification criteria
- **[data-factories.md](../.bmad/bmm/testarch/knowledge/data-factories.md)** - Factory function patterns with overrides
- **[fixture-architecture.md](../.bmad/bmm/testarch/knowledge/fixture-architecture.md)** - Pure function → Fixture → mergeTests pattern
- **[test-quality.md](../.bmad/bmm/testarch/knowledge/test-quality.md)** - Definition of Done for tests

See [tea-index.csv](../.bmad/bmm/testarch/tea-index.csv) for complete knowledge base.

---

## Appendix A: Risk Mitigation Details

### R-001 (Score 9): GET /scenes Returns Incorrect Data

**Category**: DATA (Data Integrity)
**Probability**: 3 (Likely) - Foreign key queries are error-prone
**Impact**: 3 (Critical) - User sees wrong project's scenes, breaks trust

**Mitigation Strategy**:
1. **API Test**: Create test with 2 projects, verify each returns only its scenes
2. **Database Constraint**: Validate foreign key `scenes.project_id → projects.id`
3. **Code Review**: Verify SQL query includes `WHERE project_id = ?`
4. **Integration Test**: E2E test with multiple projects, navigate between them

**Success Criteria**: Test passes with 3+ projects in database, correct scenes per project

**Owner**: Dev team
**Deadline**: Before Story 4.1 marked "done"

---

### R-002 (Score 6): Scene Order Incorrect

**Category**: BUS (Business Impact)
**Probability**: 2 (Possible) - Ordering bugs are common
**Impact**: 3 (Critical) - Breaks narrative flow, confuses users

**Mitigation Strategy**:
1. **API Test**: Verify `ORDER BY scene_number ASC` in SQL query
2. **E2E Test**: Seed scenes out of order (3, 1, 2), verify UI displays (1, 2, 3)
3. **Code Review**: Verify no accidental re-sorting in client code

**Success Criteria**: Tests pass with scenes seeded in random order

**Owner**: Dev team
**Deadline**: Before Story 4.1 marked "done"

---

### R-003 (Score 6): Race Condition (UI Before Data)

**Category**: TECH (Technical/Architecture)
**Probability**: 3 (Likely) - Race conditions are common in async code
**Impact**: 2 (Degraded) - Empty UI flashes, then populates (bad UX)

**Mitigation Strategy**:
1. **E2E Test**: Verify loading skeleton displays immediately
2. **Code Pattern**: Use network-first pattern (await responsePromise before render)
3. **State Management**: Proper loading/error/success state handling

**Success Criteria**: Loading indicator visible from page load until data arrives

**Owner**: Dev team
**Deadline**: Before Story 4.1 marked "done"

---

### R-004 (Score 6): Empty State Not Shown

**Category**: BUS (Business Impact)
**Probability**: 2 (Possible) - Conditional rendering bugs are common
**Impact**: 3 (Critical) - User sees blank page, assumes app broken

**Mitigation Strategy**:
1. **API Test**: Verify endpoint returns empty array for project with 0 scenes
2. **E2E Test**: Seed project with no scenes, verify empty state message displays
3. **Component Test**: Test conditional rendering logic

**Success Criteria**: Empty state displays with message and "Back to Script Generation" button

**Owner**: Dev team
**Deadline**: Before Story 4.1 marked "done"

---

## Appendix B: Test File Structure

```
ai-video-generator/tests/
├── api/
│   ├── scenes.test.ts                    # GET /api/projects/[id]/scenes tests
│   │   ├── [4.1-API-001] Correct scenes for project
│   │   ├── [4.1-API-002] Scenes ordered by scene_number ASC
│   │   ├── [4.1-API-003] 404 for non-existent project
│   │   ├── [4.1-API-004] Empty array for project with no scenes
│   │   ├── [4.1-API-005] 500 for database errors
│   │   ├── [4.1-API-006] Validates project_id format
│   │   └── [4.1-API-007] Returns all scene fields
│   │
├── integration/
│   ├── visual-curation.test.ts          # E2E tests for VisualCuration page
│   │   ├── [4.1-E2E-001] Scenes in sequential order
│   │   ├── [4.1-E2E-002] Scene number and text displayed
│   │   ├── [4.1-E2E-003] Empty state displays
│   │   ├── [4.1-E2E-004] Workflow validation (current_step)
│   │   ├── [4.1-E2E-005] Loading skeleton displays
│   │   ├── [4.1-E2E-006] Error message (network failure)
│   │   ├── [4.1-E2E-007] Error message (500 error)
│   │   ├── [4.1-E2E-008] Responsive layout (1920px)
│   │   ├── [4.1-E2E-009] Responsive layout (768px)
│   │   ├── [4.1-E2E-010] Retry button re-fetches
│   │   └── [4.1-E2E-011] "Back" button in empty state
│   │
├── unit/
│   ├── components/
│   │   ├── SceneCard.test.ts            # SceneCard component tests
│   │   │   ├── [4.1-UNIT-001] Renders scene number and text
│   │   │   ├── [4.1-UNIT-002] Handles long text (500+ words)
│   │   │   └── [4.1-UNIT-004] Duration indicator displays
│   │   │
│   │   ├── Skeleton.test.ts             # Skeleton component tests
│   │   │   └── [4.1-UNIT-003] Displays 3 placeholders
│   │   │
│   │   └── VisualCurationClient.test.ts # Client component tests
│   │       └── [4.1-UNIT-005] State management
│   │
├── performance/
│   └── visual-curation.perf.test.ts     # Performance tests
│       └── [4.1-PERF-001] Page renders 10 scenes <2s
│
├── fixtures/
│   └── database.fixture.ts              # Database fixture with auto-cleanup
│
├── factories/
│   ├── project.factory.ts               # Project data factory
│   ├── scene.factory.ts                 # Scene data factory
│   └── scene-set.factory.ts             # Scene collection factory
│
└── page-objects/
    └── visual-curation.page.ts          # Page object for E2E tests
```

---

**End of Test Design Document**

**Generated By**: BMad TEA Agent v4.0
**Workflow**: testarch-test-design (Epic-Level Mode)
**Review Status**: ✅ Ready for team review
**Next Action**: Schedule test design review meeting, then run `*atdd` workflow to generate P0 tests
