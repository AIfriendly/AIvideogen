<story-context id="3.1-youtube-api-client-setup" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.1</storyId>
    <title>YouTube API Client Setup & Configuration</title>
    <status>Ready</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow (SM Agent)</generator>
    <sourceStoryPath>docs/stories/story-3.1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer implementing Epic 3 Visual Content Sourcing</asA>
    <iWant>A robust YouTube Data API v3 client with authentication, quota management, rate limiting, and comprehensive error handling</iWant>
    <soThat>Stories 3.2-3.5 can reliably search YouTube for B-roll footage without worrying about API limits, authentication, or infrastructure concerns</soThat>

    <tasks>
      <task id="1" title="Install YouTube API Dependencies and Setup Environment">
        - Add @googleapis/youtube package (v17.0.0+)
        - Create .env.local.example with YouTube configuration variables
        - Document API key acquisition process in docs/setup-guide.md
        - Add environment variable validation script
        - Test environment setup on clean installation
      </task>

      <task id="2" title="Create YouTube API Client Core Infrastructure">
        - Create lib/youtube/types.ts with VideoResult, SearchOptions, QuotaUsage, YouTubeError interfaces
        - Create lib/youtube/client.ts with YouTubeAPIClient class
        - Implement constructor with API key validation
        - Implement searchVideos() method
        - Implement transformSearchResult() helper
        - Add comprehensive JSDoc documentation
      </task>

      <task id="3" title="Implement Quota Tracking System">
        - Create lib/youtube/quota-tracker.ts with QuotaTracker class
        - Implement quota cost tracking (search = 100 units)
        - Implement quota reset at midnight Pacific Time
        - Implement cache persistence (.cache/youtube-quota.json)
        - Add warning log at 80% quota usage
        - Handle quota exceeded errors
      </task>

      <task id="4" title="Implement Rate Limiting with Sliding Window">
        - Create lib/youtube/rate-limiter.ts with RateLimiter class
        - Implement sliding window algorithm (100 req per 100 seconds)
        - Implement request queueing for burst traffic
        - Add delay calculation logic
        - Test with concurrent request simulation
      </task>

      <task id="5" title="Implement Exponential Backoff Retry Logic">
        - Create lib/youtube/retry-handler.ts with RetryHandler class
        - Implement exponential backoff calculation (1s, 2s, 4s)
        - Implement retryable error detection (5xx, 429, network)
        - Add circuit breaker pattern (5 consecutive failures)
        - Integrate with YouTubeAPIClient.searchVideos()
      </task>

      <task id="6" title="Implement searchVideos() Method">
        - Add input validation (query, maxResults)
        - Check quota availability before request
        - Acquire rate limit slot
        - Execute YouTube API search with retry
        - Transform results to VideoResult[]
        - Increment quota usage
        - Handle API errors (401, 403, 429, 5xx)
      </task>

      <task id="7" title="Implement Comprehensive Error Handling">
        - Create lib/youtube/error-handler.ts
        - Map error codes to YouTubeErrorCode enum
        - Generate actionable error messages with guidance
        - Add error documentation link
        - Create docs/troubleshooting-youtube-api.md
      </task>

      <task id="8" title="Implement Logging System">
        - Create lib/youtube/logger.ts with YouTubeLogger class
        - Implement structured JSON logging format
        - Add request/response logging
        - Add quota usage logging
        - Add rate limit delay logging
        - Add error logging with context
      </task>

      <task id="9" title="Create API Endpoint for YouTube Client Testing">
        - Create app/api/youtube/test/route.ts
        - Implement GET handler with test search
        - Return quota usage and test results
        - Handle missing/invalid API key errors
        - Test manually with various API key states
      </task>

      <task id="10" title="Write Unit Tests for YouTube Client">
        - Create tests/unit/youtube-client.test.ts
        - Create tests/unit/quota-tracker.test.ts
        - Create tests/unit/rate-limiter.test.ts
        - Create tests/unit/retry-handler.test.ts
        - Create tests/unit/error-handler.test.ts
        - Achieve >90% code coverage
      </task>

      <task id="11" title="Write Integration Tests">
        - Create tests/integration/youtube-client.test.ts
        - Test full search workflow
        - Test quota tracking across requests
        - Test rate limiting with burst
        - Test retry logic with simulated failures
        - Use nock/VCR for HTTP mocking
      </task>

      <task id="12" title="Create YouTube Client Factory Function">
        - Create lib/youtube/factory.ts
        - Implement singleton pattern for client instance
        - Add reset function for testing
        - Update all code to use factory
      </task>

      <task id="13" title="Update Documentation">
        - Update docs/setup-guide.md with YouTube API setup
        - Create docs/troubleshooting-youtube-api.md
        - Update README.md with YouTube configuration
        - Create docs/youtube-api-integration.md technical docs
        - Add inline JSDoc comments
        - Create API reference documentation
      </task>

      <task id="14" title="Add Environment Variable Validation on Startup">
        - Add startup validation in app initialization
        - Create lib/youtube/validate-config.ts
        - Add health check endpoint (app/api/health/route.ts)
        - Add UI indicator for API status
        - Test with various configurations
      </task>

      <task id="15" title="Create Developer Testing Tools">
        - Create scripts/test-youtube-api.ts CLI tool
        - Add commands: --test-auth, --search, --quota, --stress-test
        - Add colored console output
        - Add npm scripts for CLI tool
        - Document in docs/developer-tools.md
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1" priority="CRITICAL">
      YouTubeAPIClient successfully initializes with valid API key from environment variable
      - Client reads YOUTUBE_API_KEY from .env.local
      - Constructor validates API key presence and format
      - Error thrown if API key missing with actionable guidance
      - API key never logged or exposed in client-side code
    </criterion>

    <criterion id="2" priority="CRITICAL">
      API client can make authenticated requests to YouTube Data API v3
      - searchVideos() method queries YouTube API successfully
      - Requests include proper authentication
      - API responses parsed into VideoResult types
      - Response includes videoId, title, thumbnail, channel, embedUrl
      - HTTP errors converted to YouTubeError types
    </criterion>

    <criterion id="3" priority="HIGH">
      Quota tracking counts requests against daily limit (10,000 units default)
      - QuotaTracker monitors API quota usage
      - Each search request = 100 units
      - getQuotaUsage() returns { used, limit, remaining, resetTime }
      - Quota persists across restarts via .cache/youtube-quota.json
      - Quota resets at midnight Pacific Time
      - Warning logged at 80% usage
      - Requests blocked when quota exceeded
    </criterion>

    <criterion id="4" priority="HIGH">
      Rate limiter prevents exceeding 100 requests per 100 seconds
      - RateLimiter implements sliding window algorithm
      - Requests delayed if rate limit would be exceeded
      - Maximum 100 requests per 100-second window enforced
      - Concurrent requests queued and processed sequentially
      - Rate limit errors from API trigger retry with backoff
    </criterion>

    <criterion id="5" priority="HIGH">
      Exponential backoff retries failed requests (max 3 attempts)
      - Retry logic for transient failures (network, 5xx, rate limits)
      - Exponential backoff delays: 1s, 2s, 4s
      - Maximum 3 retry attempts before final failure
      - Retry only retryable errors (not 4xx client errors)
      - Circuit breaker prevents cascading failures
    </criterion>

    <criterion id="6" priority="CRITICAL">
      Error messages provide actionable guidance
      - Missing API key: "YouTube API key not configured. Add YOUTUBE_API_KEY to .env.local"
      - Invalid API key: "YouTube API key is invalid. Verify key in Google Cloud Console."
      - Quota exceeded: "YouTube API daily quota exceeded (10,000 units). Quota resets at midnight PT."
      - Rate limited: "YouTube API rate limit reached. Request will retry automatically."
      - Network error: "Failed to connect to YouTube API. Check internet connection."
      - All errors logged with full context
    </criterion>

    <criterion id="7" priority="MEDIUM">
      Logging captures request count, quota usage, and errors for debugging
      - Each API request logged with timestamp, method, query, quota cost
      - Quota usage logged after each request
      - Errors logged with error code, message, context, retry count
      - Rate limit delays logged
      - Structured JSON format for log aggregation
      - Log levels: DEBUG, INFO, WARN, ERROR
    </criterion>

    <criterion id="8" priority="CRITICAL">
      When YOUTUBE_API_KEY is missing, system displays actionable error
      - Constructor throws YouTubeError with YOUTUBE_API_KEY_NOT_CONFIGURED code
      - Error message includes setup instructions
      - Error propagated to API endpoint with HTTP 503
      - UI displays user-friendly error in visual sourcing workflow
      - Documentation link included
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 3: Visual Content Sourcing (YouTube API)</title>
        <section>Story 3.1 Definition</section>
        <snippet>Set up YouTube Data API v3 client with authentication and quota management infrastructure. Implement YouTubeAPIClient class as core interface for all YouTube operations with quota tracking, rate limiting (100 req/100s), and exponential backoff retry logic.</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture - Epic 3 Integration</title>
        <section>Epic 3: Visual Content Sourcing</section>
        <snippet>YouTube Data API v3 integration for B-roll sourcing. YouTubeAPIClient in lib/youtube/client.ts handles authentication via API key, quota tracking (10,000 units/day default), rate limiting (100 req per 100s), and exponential backoff.</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>Project Structure - YouTube Module</title>
        <section>lib/youtube/ Directory</section>
        <snippet>lib/youtube/ contains client.ts (YouTubeAPIClient), analyze-scene.ts (scene text analysis), filter-results.ts (content filtering), quota-tracker.ts, rate-limiter.ts, retry-handler.ts, error-handler.ts, logger.ts, factory.ts</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>External Services</title>
        <section>YouTube Data API</section>
        <snippet>External service: YouTube Data API v3 for B-roll search and metadata retrieval. Requires YOUTUBE_API_KEY environment variable. Free tier: 10,000 quota units per day.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>ai-video-generator/src/lib/llm/provider.ts</path>
        <kind>interface</kind>
        <symbol>LLMProvider</symbol>
        <lines>28-38</lines>
        <reason>
          LLMProvider interface pattern from Epic 1 Story 1.3. YouTubeAPIClient should follow same abstraction pattern:
          - Interface defining contract (LLMProvider = YouTubeAPIClient interface)
          - Multiple implementations (OllamaProvider/GeminiProvider = YouTubeAPIClient)
          - Factory function for instantiation (lib/llm/factory.ts pattern = lib/youtube/factory.ts)
          - Error handling with actionable messages (see ollama-provider.ts)
        </reason>
      </artifact>

      <artifact>
        <path>ai-video-generator/src/lib/llm/ollama-provider.ts</path>
        <kind>service</kind>
        <symbol>OllamaProvider</symbol>
        <lines>1-136</lines>
        <reason>
          Epic 1 error handling pattern to replicate for YouTube client:
          - Constructor validates connection/API key (lines 31-56)
          - Custom error handling method (lines 89-135)
          - User-friendly actionable error messages (lines 98-105, 109-117)
          - Timeout handling with guidance (lines 121-130)
          - Error types: ECONNREFUSED, model not found, timeout - map to YouTube equivalents
        </reason>
      </artifact>

      <artifact>
        <path>ai-video-generator/src/lib/db/client.ts</path>
        <kind>database</kind>
        <symbol>db</symbol>
        <lines>1-22</lines>
        <reason>
          Database client singleton pattern from Epic 1 Story 1.2:
          - Single instance exported (line 21)
          - Configuration via path.join (line 12)
          - Pragma configuration (line 18)
          Apply same singleton pattern to YouTubeAPIClient via factory.ts
        </reason>
      </artifact>

      <artifact>
        <path>ai-video-generator/src/lib/db/queries.ts</path>
        <kind>database</kind>
        <symbol>Project, Scene interfaces + CRUD functions</symbol>
        <lines>1-815</lines>
        <reason>
          Epic 2 database patterns for Story 3.5 visual_suggestions table:
          - Interface definitions (Project lines 35-49, Scene lines 391-401)
          - CRUD function patterns: create, get, update, delete (lines 145-720)
          - Foreign key error handling (lines 161-164, 261-264, 441-443)
          - Transaction patterns for bulk operations (lines 472-519)
          Story 3.5 will create similar CRUD for visual_suggestions table referencing scenes
        </reason>
      </artifact>

      <artifact>
        <path>ai-video-generator/src/app/api/projects/route.ts</path>
        <kind>api-endpoint</kind>
        <symbol>GET, POST handlers</symbol>
        <lines>1-168</lines>
        <reason>
          Epic 1 API endpoint pattern for Story 3.1 test endpoint (Task 9):
          - Standard response format (lines 7-10)
          - Error handling structure (lines 66-77, 150-162)
          - Success/error response pattern with status codes
          - JSDoc documentation pattern (lines 22-53, 80-124)
          Apply to app/api/youtube/test/route.ts
        </reason>
      </artifact>

      <artifact>
        <path>ai-video-generator/.env.local.example</path>
        <kind>config</kind>
        <symbol>Environment variables</symbol>
        <lines>1-57</lines>
        <reason>
          Environment variable pattern from Epic 1 &amp; 2:
          - Structured sections with comments (lines 3-7, 9-21, 23-44)
          - Provider selection pattern (LLM_PROVIDER, TTS_PROVIDER)
          - Service URL configuration (OLLAMA_BASE_URL)
          - Timeout configuration (TTS_TIMEOUT_MS_COLD/WARM)
          Add YouTube section: YOUTUBE_API_KEY, YOUTUBE_API_QUOTA_LIMIT, YOUTUBE_API_RATE_LIMIT
        </reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@googleapis/youtube" version="^17.0.0" usage="YouTube Data API v3 client library" />
        <package name="better-sqlite3" version="12.4.1" usage="SQLite database for quota cache persistence" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint category="architecture">
      Follow Epic 1 provider abstraction pattern: Interface → Implementation → Factory
      - Create YouTubeAPIClient interface (similar to LLMProvider interface)
      - Implement concrete YouTubeAPIClient class
      - Create factory function with singleton pattern (lib/youtube/factory.ts)
      - Never instantiate client directly; always use factory
    </constraint>

    <constraint category="error-handling">
      Error messages MUST be actionable and user-friendly (Epic 1 pattern)
      - Include specific troubleshooting steps
      - Provide command examples (e.g., "Run: ollama pull llama3.2")
      - Link to documentation
      - Never expose internal implementation details
      - Use error codes for programmatic handling
    </constraint>

    <constraint category="database">
      Quota cache persistence via .cache/ directory (follows Epic 2 audio cache pattern)
      - Cache file: .cache/youtube-quota.json
      - Format: { used, limit, resetTime }
      - Handle corrupted cache gracefully (reset to defaults)
      - Create .cache/ directory if not exists
      - Add .cache/ to .gitignore
    </constraint>

    <constraint category="api-design">
      API endpoint standard response format (Epic 1 pattern from api/projects/route.ts)
      - Success: { success: true, data: {...} }
      - Error: { success: false, error: { message, code } }
      - Use appropriate HTTP status codes (200, 400, 401, 403, 500, 503)
      - Include JSDoc documentation with example request/response
    </constraint>

    <constraint category="testing">
      Epic 1 &amp; 2 test coverage requirements apply
      - Unit tests for all modules (>90% coverage)
      - Integration tests for full workflows
      - Mock external services (YouTube API)
      - Test error scenarios extensively
      - Use consistent test structure across stories
    </constraint>

    <constraint category="environment">
      Environment variable management pattern from Epic 1 &amp; 2
      - All configuration via .env.local
      - .env.local.example documents all variables
      - Validate on application startup
      - Never hardcode API keys or secrets
      - Support for optional configuration with defaults
    </constraint>

    <constraint category="logging">
      Structured logging for production observability
      - JSON format for log aggregation
      - Include context: timestamp, requestId, quotaUsage, error details
      - Log levels: DEBUG (development only), INFO, WARN, ERROR
      - Never log sensitive data (API keys, tokens)
      - Rate limit logs to prevent log flooding
    </constraint>

    <constraint category="performance">
      Rate limiting and quota management are non-negotiable
      - MUST implement sliding window rate limiter (not fixed window)
      - MUST track quota across application restarts
      - MUST implement exponential backoff for retries
      - MUST use circuit breaker pattern
      - Request queueing max limit: 100 pending requests
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>YouTubeAPIClient</name>
      <kind>Class</kind>
      <signature>
        class YouTubeAPIClient {
          constructor(apiKey?: string);
          searchVideos(query: string, options?: SearchOptions): Promise&lt;VideoResult[]&gt;;
          getQuotaUsage(): QuotaUsage;
          isQuotaExceeded(): boolean;
        }
      </signature>
      <path>lib/youtube/client.ts (new file)</path>
    </interface>

    <interface>
      <name>VideoResult</name>
      <kind>TypeScript Interface</kind>
      <signature>
        interface VideoResult {
          videoId: string;
          title: string;
          thumbnailUrl: string;
          channelTitle: string;
          embedUrl: string;
          publishedAt: string;
          description: string;
          viewCount?: number;
          likeCount?: number;
          duration?: string;
        }
      </signature>
      <path>lib/youtube/types.ts (new file)</path>
    </interface>

    <interface>
      <name>SearchOptions</name>
      <kind>TypeScript Interface</kind>
      <signature>
        interface SearchOptions {
          maxResults?: number;
          relevanceLanguage?: string;
          videoEmbeddable?: boolean;
          videoDuration?: 'short' | 'medium' | 'long';
          order?: 'relevance' | 'date' | 'viewCount' | 'rating';
        }
      </signature>
      <path>lib/youtube/types.ts (new file)</path>
    </interface>

    <interface>
      <name>QuotaUsage</name>
      <kind>TypeScript Interface</kind>
      <signature>
        interface QuotaUsage {
          used: number;
          limit: number;
          remaining: number;
          resetTime: Date;
        }
      </signature>
      <path>lib/youtube/types.ts (new file)</path>
    </interface>

    <interface>
      <name>YouTubeError</name>
      <kind>Class extending Error</kind>
      <signature>
        class YouTubeError extends Error {
          constructor(
            public code: YouTubeErrorCode,
            message: string,
            public context?: Record&lt;string, any&gt;
          )
        }

        enum YouTubeErrorCode {
          API_KEY_NOT_CONFIGURED,
          API_KEY_INVALID,
          QUOTA_EXCEEDED,
          RATE_LIMITED,
          NETWORK_ERROR,
          INVALID_REQUEST,
          SERVICE_UNAVAILABLE
        }
      </signature>
      <path>lib/youtube/types.ts (new file)</path>
    </interface>

    <interface>
      <name>GET /api/youtube/test</name>
      <kind>REST API Endpoint</kind>
      <signature>
        GET /api/youtube/test

        Response 200:
        {
          success: true,
          message: "YouTube API client initialized successfully",
          quotaUsage: { used, limit, remaining, resetTime },
          testResults: { searchWorking: true, videoId, title }
        }

        Response 503:
        {
          success: false,
          error: {
            code: "YOUTUBE_API_KEY_NOT_CONFIGURED",
            message: "YouTube API key not configured. Add YOUTUBE_API_KEY to .env.local",
            guidance: "See setup guide: /docs/setup-guide.md#youtube-api"
          }
        }
      </signature>
      <path>app/api/youtube/test/route.ts (new file)</path>
    </interface>

    <interface>
      <name>QuotaTracker</name>
      <kind>Class</kind>
      <signature>
        class QuotaTracker {
          constructor(limit: number);
          incrementUsage(cost: number): void;
          getUsage(): QuotaUsage;
          isExceeded(): boolean;
          getRemainingQuota(): number;
          getResetTime(): Date;
        }
      </signature>
      <path>lib/youtube/quota-tracker.ts (new file)</path>
    </interface>

    <interface>
      <name>RateLimiter</name>
      <kind>Class</kind>
      <signature>
        class RateLimiter {
          constructor(maxRequests: number, windowMs: number);
          acquire(): Promise&lt;void&gt;;
        }
      </signature>
      <path>lib/youtube/rate-limiter.ts (new file)</path>
    </interface>

    <interface>
      <name>RetryHandler</name>
      <kind>Class</kind>
      <signature>
        class RetryHandler {
          constructor(maxRetries?: number, baseDelay?: number);
          executeWithRetry&lt;T&gt;(
            operation: () =&gt; Promise&lt;T&gt;,
            context: string
          ): Promise&lt;T&gt;;
        }
      </signature>
      <path>lib/youtube/retry-handler.ts (new file)</path>
    </interface>

    <interface>
      <name>getYouTubeClient</name>
      <kind>Factory Function</kind>
      <signature>
        function getYouTubeClient(): YouTubeAPIClient;
        function resetYouTubeClient(): void;
      </signature>
      <path>lib/youtube/factory.ts (new file)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Follow Epic 1 &amp; 2 testing patterns:
      - Unit tests for all modules in tests/unit/ directory
      - Integration tests in tests/integration/ directory
      - Use Jest or Vitest (project decision pending)
      - Mock external dependencies (YouTube API, file system)
      - Test file naming: [module-name].test.ts
      - Aim for >90% code coverage
      - Test happy path, error cases, edge cases, boundary conditions
      - Use descriptive test names: "should [expected behavior] when [condition]"
    </standards>

    <locations>
      - tests/unit/youtube-client.test.ts
      - tests/unit/quota-tracker.test.ts
      - tests/unit/rate-limiter.test.ts
      - tests/unit/retry-handler.test.ts
      - tests/unit/error-handler.test.ts
      - tests/integration/youtube-client.test.ts
    </locations>

    <ideas>
      <test ac="1">
        - Test constructor with valid API key from environment
        - Test constructor with missing API key throws YouTubeError
        - Test constructor with invalid API key format throws error
        - Test API key never logged in console or error messages
        - Test API key validation on initialization
      </test>

      <test ac="2">
        - Test searchVideos() with valid query returns VideoResult[]
        - Test searchVideos() includes authentication in request
        - Test searchVideos() parses API response correctly
        - Test searchVideos() handles missing optional fields
        - Test searchVideos() network timeout handling
        - Mock YouTube API responses for consistent testing
      </test>

      <test ac="3">
        - Test QuotaTracker increments usage by 100 units per search
        - Test QuotaTracker getUsage() returns correct values
        - Test QuotaTracker persists to .cache/youtube-quota.json
        - Test QuotaTracker loads from cache on restart
        - Test QuotaTracker resets at midnight Pacific Time
        - Test QuotaTracker logs warning at 80% usage
        - Test QuotaTracker blocks requests when quota exceeded
        - Test QuotaTracker handles corrupted cache file
      </test>

      <test ac="4">
        - Test RateLimiter allows 100 requests immediately
        - Test RateLimiter delays 101st request
        - Test RateLimiter sliding window cleanup
        - Test RateLimiter queue processing FIFO
        - Test RateLimiter concurrent request handling
        - Test RateLimiter queue size limit (100 max)
        - Simulate burst of 200 parallel requests
      </test>

      <test ac="5">
        - Test RetryHandler retries on network error
        - Test RetryHandler retries on 5xx server error
        - Test RetryHandler retries on 429 rate limit
        - Test RetryHandler does not retry on 4xx client error
        - Test RetryHandler exponential backoff delays (1s, 2s, 4s)
        - Test RetryHandler max 3 retry attempts
        - Test RetryHandler circuit breaker opens after 5 failures
        - Test RetryHandler circuit breaker closes after cooldown
      </test>

      <test ac="6">
        - Test each error type generates correct actionable message
        - Test error messages include troubleshooting steps
        - Test error messages include documentation links
        - Test errors logged with full context
        - Test API_KEY_NOT_CONFIGURED message and code
        - Test API_KEY_INVALID message and code
        - Test QUOTA_EXCEEDED message includes reset time
        - Test NETWORK_ERROR message includes connectivity guidance
      </test>

      <test ac="7">
        - Test logger formats logs as JSON
        - Test logger includes timestamp, level, message, context
        - Test logger logs each API request
        - Test logger logs quota usage after request
        - Test logger logs rate limit delays
        - Test logger logs errors with stack trace
        - Test logger sanitizes sensitive data (API keys)
        - Test log level filtering (DEBUG in dev, INFO in prod)
      </test>

      <test ac="8">
        - Test missing YOUTUBE_API_KEY throws on initialization
        - Test error code is YOUTUBE_API_KEY_NOT_CONFIGURED
        - Test error message includes setup instructions
        - Test API endpoint returns 503 when key missing
        - Test UI displays user-friendly error
        - Integration test: End-to-end error flow from missing key to UI
      </test>

      <test task="9">
        - Test GET /api/youtube/test with valid API key returns 200
        - Test GET /api/youtube/test with missing key returns 503
        - Test GET /api/youtube/test with invalid key returns 401
        - Test response includes quota usage
        - Test response includes test search results
        - Test endpoint logs request/response
      </test>

      <test task="12">
        - Test getYouTubeClient() returns singleton instance
        - Test multiple calls return same instance
        - Test resetYouTubeClient() clears singleton
        - Test factory propagates initialization errors
        - Test factory used in all API routes and scene analyzer
      </test>
    </ideas>
  </tests>
</story-context>
