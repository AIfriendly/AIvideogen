# Story 2.2: Database Schema Updates for Content Generation

**Epic:** Epic 2 - Content Generation Pipeline + Voice Selection
**Status:** Ready
**Ready for Development:** 2025-11-07
**Approved By:** Architect (Winston)
**Created:** 2025-11-07
**Owner:** Dev Agent

## Goal

Extend the database schema to support voice selection, script generation tracking, and scene-level audio management. This story establishes the data foundation for the content generation pipeline by adding the `scenes` table and enhancing the `projects` table with voice and script tracking fields.

## Context

As we move into Epic 2's content generation pipeline, we need persistent storage for:
- **Voice Selection:** Track which TTS voice profile is assigned to each project
- **Script Scenes:** Store individual script segments with their associated audio files
- **Generation State:** Track whether scripts have been generated and voices selected
- **Audio Metadata:** Store audio file paths, durations, and timing information

This schema extension follows the pattern established in Epic 1 Story 1.2, using SQLite with better-sqlite3, foreign key constraints, and performance-optimized indexes.

The scenes table is the core data structure for managing the script-to-audio pipeline. Each scene represents one segment of the script with its corresponding audio file, duration, and metadata.

## Tasks

### 1. Project Table Schema Updates

**Add new columns to projects table:**
- `voice_id` (TEXT): Stores the selected TTS voice identifier
- `script_generated` (BOOLEAN): Tracks whether script generation is complete
- `voice_selected` (BOOLEAN): Tracks whether voice selection is complete
- `total_duration` (REAL): Aggregated duration of all scenes in seconds

**SQL Migration:**
```sql
ALTER TABLE projects ADD COLUMN voice_id TEXT;
ALTER TABLE projects ADD COLUMN script_generated BOOLEAN DEFAULT false;
ALTER TABLE projects ADD COLUMN voice_selected BOOLEAN DEFAULT false;
ALTER TABLE projects ADD COLUMN total_duration REAL;
```

### 2. Create Scenes Table

**Table Definition:**
```sql
CREATE TABLE scenes (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  scene_number INTEGER NOT NULL,
  text TEXT NOT NULL,              -- Original script text from LLM
  sanitized_text TEXT,             -- Cleaned text for TTS input
  audio_file_path TEXT,            -- Path to generated MP3 file
  duration REAL,                   -- Duration in seconds
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  UNIQUE(project_id, scene_number)
);
```

**Index Definitions:**
```sql
CREATE INDEX idx_scenes_project ON scenes(project_id);
CREATE INDEX idx_scenes_number ON scenes(scene_number);
```

**Schema Design Notes:**
- `id`: UUID v4 primary key
- `project_id`: Foreign key with CASCADE delete to maintain referential integrity
- `scene_number`: Sequential ordering within project (1-based indexing)
- `text`: Original script text as generated by LLM
- `sanitized_text`: Text after cleaning/preparation for TTS engine
- `audio_file_path`: Relative path from project root to generated audio file
- `duration`: Computed after TTS generation, used for video timing
- `UNIQUE(project_id, scene_number)`: Prevents duplicate scene numbers

### 3. Database Migration Script

**File:** `lib/db/migrations/002_content_generation_schema.ts`

**Requirements:**
- Check if migration has already been applied
- Use transactions for atomicity
- Handle migration version tracking
- Provide rollback capability
- Log migration progress

**Migration Functions:**
```typescript
export async function up(db: Database): Promise<void>;
export async function down(db: Database): Promise<void>;
```

### 4. Query Functions for Scenes

**File:** `lib/db/queries.ts` (extend existing)

**CRUD Operations:**

```typescript
// CREATE
export function createScene(db: Database, scene: SceneInsert): Scene;
export function createScenes(db: Database, scenes: SceneInsert[]): Scene[];

// READ
export function getSceneById(db: Database, id: string): Scene | null;
export function getScenesByProjectId(db: Database, projectId: string): Scene[];
export function getSceneByNumber(db: Database, projectId: string, sceneNumber: number): Scene | null;
export function countScenes(db: Database, projectId: string): number;

// UPDATE
export function updateScene(db: Database, id: string, updates: Partial<SceneUpdate>): Scene;
export function updateSceneAudio(db: Database, id: string, audioPath: string, duration: number): Scene;
export function updateSceneSanitizedText(db: Database, id: string, sanitizedText: string): Scene;

// DELETE
export function deleteScene(db: Database, id: string): void;
export function deleteScenesByProjectId(db: Database, projectId: string): void;
```

**Project Table Query Updates:**
```typescript
// Add to existing project queries
export function updateProjectVoice(db: Database, id: string, voiceId: string): Project;
export function markScriptGenerated(db: Database, id: string): Project;
export function markVoiceSelected(db: Database, id: string, voiceId: string): Project;
export function updateProjectDuration(db: Database, id: string, totalDuration: number): Project;
```

**Query Implementation Requirements:**
- Use parameterized queries for SQL injection prevention
- Return typed results matching TypeScript interfaces
- Throw descriptive errors for constraint violations
- Use transactions for multi-row operations
- Leverage indexes for performance

### 5. TypeScript Type Definitions

**File:** `types/database.ts` (extend existing)

**Scene Types:**
```typescript
export interface Scene {
  id: string;
  project_id: string;
  scene_number: number;
  text: string;
  sanitized_text: string | null;
  audio_file_path: string | null;
  duration: number | null;
  created_at: string;
  updated_at: string;
}

export interface SceneInsert {
  id?: string;  // Auto-generated if not provided
  project_id: string;
  scene_number: number;
  text: string;
  sanitized_text?: string | null;
  audio_file_path?: string | null;
  duration?: number | null;
}

export interface SceneUpdate {
  text?: string;
  sanitized_text?: string | null;
  audio_file_path?: string | null;
  duration?: number | null;
  updated_at?: string;
}
```

**Project Type Updates:**
```typescript
export interface Project {
  // ... existing fields
  voice_id: string | null;
  script_generated: boolean;
  voice_selected: boolean;
  total_duration: number | null;
}
```

### 6. Integration with Existing Database Layer

**Update:** `lib/db/index.ts`
- Export new query functions
- Ensure migration runs on database initialization
- Verify foreign key constraints are enabled

**Update:** `lib/db/init.ts`
- Register migration 002 in migration registry
- Ensure migrations run in order

### 7. Testing Strategy

**Unit Tests:** `tests/db/scenes.test.ts`
- Test all CRUD operations
- Verify foreign key constraint enforcement
- Test unique constraint on (project_id, scene_number)
- Test CASCADE delete behavior
- Verify index usage with EXPLAIN QUERY PLAN

**Integration Tests:**
- Create project, add scenes, verify retrieval
- Update scene audio metadata
- Delete project, verify scenes cascade delete
- Bulk insert scenes with transaction rollback

## Acceptance Criteria

- [x] Projects table includes `voice_id`, `script_generated`, `voice_selected`, `total_duration` fields
- [x] Scenes table created with all required fields and foreign key to projects
- [x] Indexes created on `scenes(project_id)` and `scenes(scene_number)`
- [x] Database migration runs successfully without data loss
- [x] Migration can be rolled back cleanly
- [x] Query functions handle CRUD operations for scenes
- [x] Query functions properly enforce constraints and return typed results
- [x] TypeScript types accurately reflect schema changes
- [x] All query functions have corresponding unit tests
- [x] Foreign key constraint `ON DELETE CASCADE` verified working
- [x] No SQL injection vulnerabilities (all queries parameterized)

## Technical Notes

### Migration Strategy

1. **Pre-Migration Backup:** Automatically backup database before migration
2. **Transaction Wrapping:** Entire migration runs in single transaction
3. **Version Tracking:** Migration version stored in `migrations` table
4. **Idempotency:** Check if columns/tables already exist before creating
5. **Rollback Plan:** `down()` function removes columns/tables added

### Rollback Plan

```sql
-- Rollback SQL (run in reverse order)
DROP INDEX IF EXISTS idx_scenes_number;
DROP INDEX IF EXISTS idx_scenes_project;
DROP TABLE IF EXISTS scenes;
ALTER TABLE projects DROP COLUMN total_duration;
ALTER TABLE projects DROP COLUMN voice_selected;
ALTER TABLE projects DROP COLUMN script_generated;
ALTER TABLE projects DROP COLUMN voice_id;
```

**Note:** SQLite has limited `ALTER TABLE DROP COLUMN` support (added in 3.35.0). If older SQLite version detected, use table recreation strategy.

### Performance Considerations

- **Indexes:** `idx_scenes_project` enables fast lookup of all scenes for a project (O(log n))
- **Foreign Keys:** Verify `PRAGMA foreign_keys = ON` is set on database connection
- **Batch Inserts:** Use `createScenes()` with prepared statements for bulk operations
- **Aggregation:** `total_duration` denormalized to avoid repeated SUM() queries

### Data Integrity

- **Referential Integrity:** Foreign key constraint ensures orphaned scenes cannot exist
- **Uniqueness:** `UNIQUE(project_id, scene_number)` prevents duplicate scene numbering
- **NOT NULL:** Required fields enforce complete data entry
- **Cascade Delete:** Deleting project automatically removes all scenes

### Audio File Path Convention

Scene audio files should follow this pattern:
```
{project_root}/audio/scenes/scene_{scene_number:03d}.mp3
```

Example: `audio/scenes/scene_001.mp3`, `audio/scenes/scene_002.mp3`

### Error Handling

Query functions should throw specific errors:
- `SceneNotFoundError`: Scene ID not found
- `ProjectNotFoundError`: Invalid project_id foreign key
- `DuplicateSceneError`: UNIQUE constraint violation on (project_id, scene_number)
- `DatabaseError`: General SQL errors

## References

- **PRD Feature 1.2:** Automated Script Generation (lines 78-102)
- **PRD Feature 1.4:** Automated Voiceover (lines 134-158)
- **Epic 1 Story 1.2:** Database Schema pattern (lines 119-139)
- **Tech Spec Epic 2:** Scene Model and Project Schema Updates

## Dependencies

- **Requires:** Story 1.2 (Database initialization and projects table)
- **Blocks:** Story 2.3 (Script Generation with LLM)
- **Blocks:** Story 2.4 (Voice Selection UI)

## Dev Agent Record

### Implementation Log

**Implementation Date:** 2025-11-07

**Summary:**
Successfully implemented Story 2.2: Database Schema Updates for Content Generation. All tasks completed including schema updates, migration script, TypeScript types, query functions, and comprehensive unit tests.

**Implementation Steps:**

1. **Schema Updates (schema.sql)**
   - Added scenes table with all required fields (id, project_id, scene_number, text, sanitized_text, audio_file_path, duration, created_at, updated_at)
   - Added foreign key constraint with ON DELETE CASCADE
   - Added UNIQUE constraint on (project_id, scene_number)
   - Created indexes: idx_scenes_project and idx_scenes_number

2. **Migration Script (002_content_generation_schema.ts)**
   - Implemented up() function to add Epic 2 fields to projects table
   - Added voice_id, script_generated, voice_selected, total_duration columns
   - Created scenes table with foreign key and unique constraints
   - Created performance indexes
   - Implemented down() function for rollback capability
   - Added idempotency checks for safe re-execution
   - Wrapped all operations in transactions for atomicity

3. **TypeScript Types (types.ts)**
   - Added Scene interface with camelCase field names
   - Added SceneRow interface for database raw results
   - Added SceneInsert interface for creation operations
   - Added SceneUpdate interface for update operations
   - Added sceneRowToScene() converter function

4. **Query Functions (queries.ts)**
   - Updated Project interface with Epic 2 fields (voice_id, script_generated, voice_selected, total_duration)
   - Updated updateProject() to handle new fields
   - Implemented Scene CRUD operations:
     - createScene() - single scene creation
     - createScenes() - bulk insert with transaction
     - getSceneById() - retrieve by ID
     - getScenesByProjectId() - get all scenes for project
     - getSceneByNumber() - get by project_id + scene_number
     - countScenes() - count scenes for project
     - updateScene() - update scene fields
     - updateSceneAudio() - convenience method for audio metadata
     - updateSceneSanitizedText() - convenience method for sanitized text
     - deleteScene() - delete single scene
     - deleteScenesByProjectId() - delete all scenes for project
   - Implemented Project Epic 2 extensions:
     - updateProjectVoice() - set voice_id
     - markScriptGenerated() - set script_generated flag
     - markVoiceSelected() - set voice_selected and voice_id
     - updateProjectDuration() - set total_duration

5. **Database Initialization (init.ts)**
   - Added migrations table for tracking applied migrations
   - Implemented ensureMigrationsTable() function
   - Implemented isMigrationApplied() check
   - Implemented markMigrationApplied() tracker
   - Added runMigrations() function to execute pending migrations
   - Updated initializeDatabase() to run migrations after schema creation
   - Made initializeDatabase() async to support migration system

6. **Unit Tests (tests/db/scenes.test.ts)**
   - Created comprehensive test suite with 28 tests
   - Tests for all Scene CRUD operations
   - Tests for Project Epic 2 extensions
   - Tests for constraint enforcement (foreign key, unique)
   - Tests for CASCADE DELETE behavior
   - Tests for transaction rollback
   - Tests for index usage with EXPLAIN QUERY PLAN
   - All tests use isolated test database (test-scenes.db)

### Files Created

1. `D:\BMAD video generator\ai-video-generator\src\lib\db\migrations\002_content_generation_schema.ts`
   - Migration script with up() and down() functions
   - Implements Epic 2 schema changes
   - Includes idempotency checks and transaction wrapping

2. `D:\BMAD video generator\ai-video-generator\tests\db\scenes.test.ts`
   - Comprehensive unit tests for Scene CRUD operations
   - Tests for Project Epic 2 extensions
   - Tests for constraint enforcement and cascade deletes
   - Tests for index performance

### Files Modified

1. `D:\BMAD video generator\ai-video-generator\src\lib\db\schema.sql`
   - Added Epic 2 section with scenes table DDL
   - Added scene indexes

2. `D:\BMAD video generator\ai-video-generator\src\lib\db\types.ts`
   - Added Scene, SceneRow, SceneInsert, SceneUpdate interfaces
   - Added sceneRowToScene() converter function

3. `D:\BMAD video generator\ai-video-generator\src\lib\db\queries.ts`
   - Updated Project interface with Epic 2 fields
   - Updated updateProject() to handle Epic 2 fields
   - Added Scene interface and all CRUD functions
   - Added Project Epic 2 extension functions

4. `D:\BMAD video generator\ai-video-generator\src\lib\db\init.ts`
   - Added migration tracking system
   - Implemented migration execution logic
   - Made initializeDatabase() async
   - Integrated migration 002 into initialization flow

### Testing Results

**Unit Tests:**
- Test suite: tests/db/scenes.test.ts
- Total tests: 28
- All tests: PASSED
- Duration: 2.09s
- Test coverage:
  - Scene CRUD operations (createScene, createScenes, getSceneById, etc.)
  - Project Epic 2 extensions (updateProjectVoice, markScriptGenerated, etc.)
  - Constraint enforcement (foreign key, unique)
  - CASCADE DELETE behavior
  - Transaction rollback on error
  - Index usage verification

**Migration Testing:**
- Migration 002 executed successfully
- All columns added to projects table (voice_id, script_generated, voice_selected, total_duration)
- Scenes table created with all fields
- Indexes created (idx_scenes_project, idx_scenes_number)
- Foreign key constraints working
- UNIQUE constraint on (project_id, scene_number) working

**Database Verification:**
- Projects table columns verified: id, name, topic, current_step, status, config_json, system_prompt_id, created_at, last_active, voice_id, script_generated, voice_selected, total_duration
- Scenes table columns verified: id, project_id, scene_number, text, sanitized_text, audio_file_path, duration, created_at, updated_at
- Indexes verified: sqlite_autoindex_scenes_1, sqlite_autoindex_scenes_2, idx_scenes_project, idx_scenes_number

**Integration Testing:**
- Created test project successfully
- Created scenes successfully
- Updated scene audio metadata successfully
- Marked script as generated successfully
- Marked voice as selected successfully
- Updated project duration successfully
- All query functions working as expected

### Issues Encountered

**Issue 1: TypeScript Import in init.ts**
- Problem: Dynamic import of migration 002 required async/await
- Solution: Made initializeDatabase() async and properly awaited migration imports
- Impact: All callers of initializeDatabase() need to await it now

**Issue 2: Boolean Representation in SQLite**
- Problem: SQLite doesn't have native BOOLEAN type
- Solution: Used INTEGER (0/1) for boolean fields with proper conversion in TypeScript
- Implementation: Added explicit boolean to integer conversion in updateProject()

**Resolution Status:**
- All issues resolved
- No blocking issues remaining
- Implementation fully functional and tested

---

**Definition of Done:**
- [x] All tasks completed
- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Integration tests written and passing
- [x] Migration tested with rollback
- [x] Code reviewed (if applicable)
- [x] Documentation updated
- [x] Changes committed to repository
